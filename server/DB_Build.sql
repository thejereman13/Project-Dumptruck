SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;

CREATE DATABASE IF NOT EXISTS dumptruckDB;
USE dumptruckDB;

DROP TABLE IF EXISTS Rooms;
CREATE TABLE Rooms (
    RoomID BIGINT NOT NULL PRIMARY KEY,
    RoomSettings TEXT
);

DROP TABLE IF EXISTS RoomAdmins;
CREATE TABLE RoomAdmins (
    RoomID BIGINT NOT NULL,
    AdminUUID VARCHAR(36) NOT NULL,
    Role INT NOT NULL
);

DROP TABLE IF EXISTS Users;
CREATE TABLE Users (
    UserID VARCHAR(36) NOT NULL,
    GID TEXT,
    UserInfo TEXT,
    PRIMARY KEY (UserID)
);



DROP FUNCTION IF EXISTS GetRoom;
DELIMITER $$
CREATE FUNCTION GetRoom (id BIGINT) RETURNS TEXT
BEGIN
    DECLARE rSettings TEXT;
    IF NOT EXISTS (SELECT 1 FROM Rooms WHERE RoomID = id) THEN
        INSERT INTO Rooms (RoomID, RoomSettings) VALUES (id, "{}");
        RETURN "{}";
    ELSE
        SELECT RoomSettings INTO rSettings FROM Rooms WHERE RoomID = id;
        RETURN rSettings;
    END IF;
END $$
DELIMITER ;

DROP FUNCTION IF EXISTS GetUserData;
DELIMITER $$
CREATE FUNCTION GetUserData (id VARCHAR(36)) RETURNS TEXT
BEGIN
    DECLARE userData TEXT;
    SET userData = "{}";
    IF EXISTS (SELECT 1 FROM Users WHERE UserID = id) THEN
        SELECT UserInfo INTO userData FROM Users WHERE UserID = id;
    END IF;
    RETURN userData;
END $$
DELIMITER ;

DROP FUNCTION IF EXISTS SetUserData;
DELIMITER $$
CREATE FUNCTION SetUserData (id VARCHAR(36), data TEXT) RETURNS INT
BEGIN
    IF EXISTS (SELECT 1 FROM Users WHERE UserID = id) THEN
        UPDATE Users SET UserInfo = data WHERE UserID = id;
        RETURN 1; -- Return Existing
    ELSE
        INSERT INTO Users (UserID, UserInfo) VALUES (id, data);
        RETURN 0; -- Return New
    END IF;
END $$
DELIMITER ;

DROP FUNCTION IF EXISTS FindGIDUser;
DELIMITER $$
CREATE FUNCTION FindGIDUser (gid TEXT) RETURNS VARCHAR(36)
BEGIN
    DECLARE uid VARCHAR(36);
    IF EXISTS (SELECT 1 FROM Users WHERE GID = gid) THEN
        SELECT UserID INTO uid FROM Users WHERE GID = gid;
    ELSE
        SET uid = "";
    END IF;
    RETURN uid;
END $$
DELIMITER ;



SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
